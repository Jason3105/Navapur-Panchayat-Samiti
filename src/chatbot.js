// Gemini API Configuration
const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;
const GEMINI_API_URL = import.meta.env.VITE_GEMINI_API_URL || 'https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent';

// Development mode with mock responses for restricted APIs
const DEVELOPMENT_MODE = false; // Set to true when API is restricted
const MOCK_RESPONSES = {
    'hello': 'Hello! I am the Navapur Panchayat Samiti AI Assistant. How can I help you today? ЁЯПЫя╕П',
    'hi': 'Namaste! Main Navapur Panchayat Samiti AI Assistant hun. Aaj main aapki kaise madad kar sakta hun? ЁЯЩП',
    'schemes': 'Here are some government schemes available:\nтАв PM-KISAN Samman Nidhi\nтАв MGNREGA\nтАв Pradhan Mantri Awas Yojana\nтАв Swachh Bharat Mission\nтАв Digital India\n\nWhich scheme would you like to know about?',
    'contact': 'Contact Information:\nЁЯУз Email: info@navapurpanchayat.gov.in\nЁЯУЮ Phone: +91-XXXXXXXXXX\nЁЯПв Address: Navapur Panchayat Office, Maharashtra\nтП░ Office Hours: 10:00 AM - 5:00 PM',
    'default': 'Thank you for your message! I am the Navapur Panchayat Samiti AI Assistant. I can help you with:\n\nтАв Government schemes information\nтАв Panchayat services\nтАв Contact details\nтАв Procedures and applications\n\nWhat would you like to know?'
};

async function getMockResponse(userMessage) {
    // Simulate API delay for realistic experience
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    const message = userMessage.toLowerCase();
    
    if (message.includes('hello') || message.includes('hi ')) {
        return MOCK_RESPONSES.hello;
    } else if (message.includes('scheme') || message.includes('рдпреЛрдЬрдирд╛') || message.includes('yojana')) {
        return MOCK_RESPONSES.schemes;
    } else if (message.includes('рдирдорд╕реНрддреЗ') || message.includes('рд╣реИрд▓реЛ') || message.includes('namaste')) {
        return MOCK_RESPONSES.hi;
    } else if (message.includes('contact') || message.includes('phone') || message.includes('email') || message.includes('рд╕рдВрдкрд░реНрдХ')) {
        return MOCK_RESPONSES.contact;
    } else {
        return MOCK_RESPONSES.default + '\n\nЁЯТм Your message: "' + userMessage + '"';
    }
}

// Debug logging for environment variables
console.log('Chatbot: Environment variables loaded');
console.log('API Key available:', !!GEMINI_API_KEY);
console.log('API URL:', GEMINI_API_URL);

// Check if required configuration is available
if (!GEMINI_API_KEY) {
    console.error('Chatbot: VITE_GEMINI_API_KEY environment variable is not set');
}

// DOM Elements (updated IDs)
const chatToggleBtn = document.getElementById('navapur-chat-toggle-btn');
const chatWindow = document.getElementById('navapur-chat-window');
const chatInput = document.getElementById('navapur-chat-input');
const sendButton = document.getElementById('navapur-send-button');
const messagesContainer = document.getElementById('navapur-chat-messages');
const languageSelect = document.getElementById('navapur-language-selector');

// Panchayat context prompt to ensure responses stay within domain
const PANCHAYAT_CONTEXT = `You are Panchayat Samiti of Navapur AI, an AI assistant specifically designed for the Panchayat Samiti of Navapur. You provide information about:
- Navapur Panchayat Samiti services, schemes, and programs
- Government schemes available through Navapur Panchayat Samiti
- Local governance matters related to Navapur
- Procedures and processes specific to Navapur Panchayat Samiti
- Contact information and office details for Navapur Panchayat Samiti
- Details of people working at the Panchayat Samiti of Navapur

Follow these guidelines:
- ALWAYS assume questions are related to Navapur Panchayat Samiti unless explicitly stated otherwise
- Provide helpful, accurate information about Navapur Panchayat Samiti services and schemes
- Reference previous conversations and maintain context throughout the chat session
- DO NOT answer questions that are completely irrelevant to panchayat services - politely redirect to Navapur Panchayat Samiti related topics
- When uncertain about specific Navapur procedures, acknowledge limitations and suggest consultation with Navapur Panchayat Samiti office staff
- IMPORTANT: Always maintain consistency in the language requested by the user throughout the conversation
- Remember and reference previous parts of the conversation when relevant
- "https://panchayatnavapur.netlify.app/" is the official website of Panchayat Samiti of Navapur`;

// Active language (default: English)
let activeLanguage = 'en';

// Conversation history to maintain context
let conversationHistory = [];

// Voice Assistant Configuration
let isListening = false;
let recognition = null;
let synthesis = window.speechSynthesis;
let currentUtterance = null;
let voiceInputUsed = false; // Track if current message was sent via voice
let voiceResponseMode = 'auto'; // 'auto', 'always', 'never'

// Rate limiting variables
let lastRequestTime = 0;
let requestCount = 0;
let requestTimes = [];
const RATE_LIMIT_WINDOW = 60000; // 1 minute in milliseconds
const MAX_REQUESTS_PER_MINUTE = 12; // Conservative limit (less than 15 to be safe)
const MIN_REQUEST_INTERVAL = 2000; // Minimum 2 seconds between requests

// Initialize the chat
function initChat() {
    // Toggle chat window visibility
    chatToggleBtn.addEventListener('click', () => {
        chatWindow.classList.toggle('active');
        if (chatWindow.classList.contains('active')) {
            chatInput.focus();
            // If this is first open, show welcome message
            if (messagesContainer.childElementCount === 0) {
                const welcomeMsg = getWelcomeMessage(activeLanguage);
                addBotMessage(welcomeMsg);
                // Add welcome message to conversation history
                conversationHistory.push({
                    role: 'model',
                    parts: [{ text: welcomeMsg }]
                });
            }
        }
    });

    // Language selection event
    languageSelect.addEventListener('change', (e) => {
        const oldLanguage = activeLanguage;
        activeLanguage = e.target.value;
        
        console.log(`Language changed from ${oldLanguage} to ${activeLanguage}`);
        
        // Clear conversation history when language changes to ensure clean context
        conversationHistory = [];
        
        // Update voice recognition language
        if (typeof updateRecognitionLanguage === 'function') {
            updateRecognitionLanguage();
        }
        
        // Stop any ongoing speech
        if (synthesis.speaking) {
            synthesis.cancel();
        }
        
        // Force voice to be used for language change message
        const oldVoiceInputUsed = voiceInputUsed;
        voiceInputUsed = true; // Temporarily enable voice for language change announcement
        
        // Wait for voices to load and then announce language change
        setTimeout(() => {
            const changeMsg = getLanguageChangeMessage(activeLanguage);
            addBotMessage(changeMsg);
            
            // Initialize conversation history with language context
            conversationHistory.push({
                role: 'model',
                parts: [{ text: changeMsg }]
            });
            
            // Reset voice input flag to previous state
            setTimeout(() => {
                voiceInputUsed = oldVoiceInputUsed;
            }, 100);
        }, 200); // Increased delay to ensure voices are loaded
    });

    // Send message events
    sendButton.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSendMessage();
        }
    });
}

// Get welcome message in selected language
function getWelcomeMessage(language) {
    const welcomeMessages = {
        'en': 'Welcome to Panchayat Samiti of Navapur AI assistant. I can help you with information about Navapur Panchayat Samiti services, schemes, and procedures. How can I assist you today?',
        'hi': 'рдирд╡рд╛рдкреБрд░ рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддрд┐ AI рд╕рд╣рд╛рдпрдХ рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИред рдореИрдВ рдирд╡рд╛рдкреБрд░ рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддрд┐ рдХреА рд╕реЗрд╡рд╛рдУрдВ, рдпреЛрдЬрдирд╛рдУрдВ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВред рдЖрдЬ рдореИрдВ рдЖрдкрдХреА рдХреИрд╕реЗ рд╕рд╣рд╛рдпрддрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВ?',
        'mr': 'рдирд╡рд╛рдкреВрд░ рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддреА AI рд╕рд╣рд╛рдпреНрдпрдХрд╛рдордзреНрдпреЗ рдЖрдкрд▓реЗ рд╕реНрд╡рд╛рдЧрдд рдЖрд╣реЗ. рдореА рдирд╡рд╛рдкреВрд░ рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддреАрдЪреНрдпрд╛ рд╕реЗрд╡рд╛, рдпреЛрдЬрдирд╛ рдЖрдгрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдВрдмрджреНрджрд▓ рдорд╛рд╣рд┐рддреА рджреЗрдК рд╢рдХрддреЛ. рдЖрдЬ рдореА рддреБрдордЪреА рдХрд╢реА рдорджрдд рдХрд░реВ рд╢рдХрддреЛ?',
        'gu': 'ркирк╡рк╛рккрлБрк░ рккркВркЪрк╛ркпркд рк╕ркорк┐ркдрк┐ AI рк╕рк╣рк╛ркпркХркорк╛ркВ ркЖрккркирлБркВ рк╕рлНрк╡рк╛ркЧркд ркЫрлЗ. рк╣рлБркВ ркирк╡рк╛рккрлБрк░ рккркВркЪрк╛ркпркд рк╕ркорк┐ркдрк┐ркирлА рк╕рлЗрк╡рк╛ркУ, ркпрлЛркЬркирк╛ркУ ркЕркирлЗ рккрлНрк░ркХрлНрк░рк┐ркпрк╛ркУ рк╡рк┐рк╢рлЗ ркорк╛рк╣рк┐ркдрлА ркЖрккрлА рк╢ркХрлБркВ ркЫрлБркВ. ркЖркЬрлЗ рк╣рлБркВ ркдркорк╛рк░рлА ркХрлЗрк╡рлА рк░рлАркдрлЗ рк╕рк╣рк╛ркп ркХрк░рлА рк╢ркХрлБркВ?',
        'ta': 'роиро╡ро╛рокрпВро░рпН рокроЮрпНроЪро╛ропродрпНродрпБ роЪрооро┐родро┐ AI роЙродро╡ро┐ропро╛ро│ро░ро┐ро▓рпН роЙроЩрпНроХро│рпИ ро╡ро░ро╡рпЗро▒рпНроХро┐ро▒рпЛроорпН. роиро╡ро╛рокрпВро░рпН рокроЮрпНроЪро╛ропродрпНродрпБ роЪрооро┐родро┐ропро┐ройрпН роЪрпЗро╡рпИроХро│рпН, родро┐роЯрпНроЯроЩрпНроХро│рпН рооро▒рпНро▒рпБроорпН роироЯрпИроорпБро▒рпИроХро│рпН рокро▒рпНро▒ро┐роп родроХро╡ро▓рпНроХро│рпИ роиро╛ройрпН ро╡ро┤роЩрпНроХ роорпБроЯро┐ропрпБроорпН. роЗройрпНро▒рпБ роиро╛ройрпН роЙроЩрпНроХро│рпБроХрпНроХрпБ роОрокрпНрокроЯро┐ роЙродро╡ роорпБроЯро┐ропрпБроорпН?',
        'te': 'р░ир░╡р░╛р░кр▒Вр░░р▒Н р░кр░Вр░Ър░╛р░пр░др▒А р░╕р░ор░┐р░др░┐ AI р░╕р░╣р░╛р░пр░Хр▒Бр░бр░┐р░Хр░┐ р░╕р▒Нр░╡р░╛р░Чр░др░В. р░ир▒Зр░ир▒Б р░ир░╡р░╛р░кр▒Вр░░р▒Н р░кр░Вр░Ър░╛р░пр░др▒А р░╕р░ор░┐р░др░┐ р░╕р▒Зр░╡р░▓р▒Б, р░кр░ер░Хр░╛р░▓р▒Б р░ор░░р░┐р░пр▒Б р░╡р░┐р░зр░╛р░ир░╛р░▓ р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░╕р░ор░╛р░Ър░╛р░░р░В р░Ер░Вр░жр░┐р░Вр░Ър░Чр░▓р░ир▒Б. р░И р░░р▒Лр░Ьр▒Б р░ир▒Зр░ир▒Б р░ор▒Ар░Хр▒Б р░Ор░▓р░╛ р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░Чр░▓р░ир▒Б?',
        'kn': 'р▓ир▓╡р▓╛р▓кр│Бр▓░р│Н р▓кр▓Вр▓Ър▓╛р▓пр▓др│Н р▓╕р▓ор▓┐р▓др▓┐ AI р▓╕р▓╣р▓╛р▓пр▓Хр▓Хр│Нр▓Хр│Ж р▓╕р│Нр▓╡р▓╛р▓Чр▓д. р▓ир▓╛р▓ир│Б р▓ир▓╡р▓╛р▓кр│Бр▓░р│Н р▓кр▓Вр▓Ър▓╛р▓пр▓др│Н р▓╕р▓ор▓┐р▓др▓┐р▓п р▓╕р│Зр▓╡р│Жр▓Чр▓│р│Б, р▓пр│Лр▓Ьр▓ир│Жр▓Чр▓│р│Б р▓ор▓др│Нр▓др│Б р▓Хр▓╛р▓░р│Нр▓пр▓╡р▓┐р▓зр▓╛р▓ир▓Чр▓│ р▓мр▓Чр│Нр▓Чр│Ж р▓ор▓╛р▓╣р▓┐р▓др▓┐ р▓ир│Ар▓бр▓мр▓╣р│Бр▓жр│Б. р▓Зр▓Вр▓жр│Б р▓ир▓╛р▓ир│Б р▓ир▓┐р▓ор▓Чр│Ж р▓╣р│Зр▓Чр│Ж р▓╕р▓╣р▓╛р▓п р▓ор▓╛р▓бр▓мр▓╣р│Бр▓жр│Б?',
        'ml': 'р┤ир┤╡р┤╛р┤кр╡Вр╡╝ р┤кр┤Юр╡Нр┤Ър┤╛р┤пр┤др╡Нр┤др╡Н р┤╕р┤ор┤┐р┤др┤┐ AI р┤╕р┤╣р┤╛р┤пр┤Хр┤др╡Нр┤др┤┐р┤▓р╡Зр┤Хр╡Нр┤Хр╡Н р┤╕р╡Нр┤╡р┤╛р┤Чр┤др┤В. р┤ир┤╡р┤╛р┤кр╡Вр╡╝ р┤кр┤Юр╡Нр┤Ър┤╛р┤пр┤др╡Нр┤др╡Н р┤╕р┤ор┤┐р┤др┤┐р┤пр╡Бр┤Яр╡Ж р┤╕р╡Зр┤╡р┤ир┤Щр╡Нр┤Щр╡╛, р┤кр┤жр╡Нр┤зр┤др┤┐р┤Хр╡╛, р┤ир┤Яр┤кр┤Яр┤┐р┤Хр╡Нр┤░р┤ор┤Щр╡Нр┤Щр╡╛ р┤Ор┤ир╡Нр┤ир┤┐р┤╡р┤пр╡Жр┤Хр╡Нр┤Хр╡Бр┤▒р┤┐р┤Ър╡Нр┤Ър╡Бр┤│р╡Нр┤│ р┤╡р┤┐р┤╡р┤░р┤Щр╡Нр┤Щр╡╛ р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤ир╡╜р┤Хр┤╛р╡╗ р┤Хр┤┤р┤┐р┤пр╡Бр┤В. р┤Зр┤ир╡Нр┤ир╡Н р┤Юр┤╛р╡╗ р┤Ор┤Щр╡Нр┤Щр┤ир╡Ж р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Ж р┤╕р┤╣р┤╛р┤пр┤┐р┤Хр╡Нр┤Хр┤╛р┤В?'
    };
    return welcomeMessages[language] || welcomeMessages['en'];
}

// Get language change message
function getLanguageChangeMessage(language) {
    const changeMessages = {
        'en': "I've switched to English. I can help you with Navapur Panchayat Samiti services and information. How can I assist you?",
        'hi': 'рдореИрдВрдиреЗ рд╣рд┐рдВрджреА рдореЗрдВ рдмрджрд▓ рджрд┐рдпрд╛ рд╣реИред рдореИрдВ рдирд╡рд╛рдкреБрд░ рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддрд┐ рдХреА рд╕реЗрд╡рд╛рдУрдВ рдФрд░ рдЬрд╛рдирдХрд╛рд░реА рдореЗрдВ рдЖрдкрдХреА рд╕рд╣рд╛рдпрддрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВред рдореИрдВ рдЖрдкрдХреА рдХреИрд╕реЗ рд╕рд╣рд╛рдпрддрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВ?',
        'mr': 'рдореА рдорд░рд╛рдареАрдд рдмрджрд▓рд▓реЛ рдЖрд╣реЗ. рдореА рдирд╡рд╛рдкреВрд░ рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддреАрдЪреНрдпрд╛ рд╕реЗрд╡рд╛ рдЖрдгрд┐ рдорд╛рд╣рд┐рддреАрд╕рд╛рдареА рддреБрдордЪреА рдорджрдд рдХрд░реВ рд╢рдХрддреЛ. рдореА рддреБрдордЪреА рдХрд╢реА рдорджрдд рдХрд░реВ рд╢рдХрддреЛ?',
        'gu': 'ркорлЗркВ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркмркжрк▓рк╛рк╡ ркХрк░рлНркпрлЛ ркЫрлЗ. рк╣рлБркВ ркирк╡рк╛рккрлБрк░ рккркВркЪрк╛ркпркд рк╕ркорк┐ркдрк┐ркирлА рк╕рлЗрк╡рк╛ркУ ркЕркирлЗ ркорк╛рк╣рк┐ркдрлА ркорк╛ркЯрлЗ ркдркорк╛рк░рлА ркоркжркж ркХрк░рлА рк╢ркХрлБркВ ркЫрлБркВ. рк╣рлБркВ ркдркорк╛рк░рлА ркХрлЗрк╡рлА рк░рлАркдрлЗ ркоркжркж ркХрк░рлА рк╢ркХрлБркВ?',
        'ta': 'роиро╛ройрпН родрооро┐ро┤рпБроХрпНроХрпБ рооро╛ро▒ро┐ро╡ро┐роЯрпНроЯрпЗройрпН. роиро╡ро╛рокрпВро░рпН рокроЮрпНроЪро╛ропродрпНродрпБ роЪрооро┐родро┐ роЪрпЗро╡рпИроХро│рпН рооро▒рпНро▒рпБроорпН родроХро╡ро▓рпБроХрпНроХрпБ роиро╛ройрпН роЙроЩрпНроХро│рпБроХрпНроХрпБ роЙродро╡ роорпБроЯро┐ропрпБроорпН. роиро╛ройрпН роЙроЩрпНроХро│рпБроХрпНроХрпБ роОрокрпНрокроЯро┐ роЙродро╡ роорпБроЯро┐ропрпБроорпН?',
        'te': 'р░ир▒Зр░ир▒Б р░др▒Жр░▓р▒Бр░Чр▒Бр░Хр▒Б р░ор░╛р░░р▒Нр░Ър░╛р░ир▒Б. р░ир░╡р░╛р░кр▒Вр░░р▒Н р░кр░Вр░Ър░╛р░пр░др▒А р░╕р░ор░┐р░др░┐ р░╕р▒Зр░╡р░▓р▒Б р░ор░░р░┐р░пр▒Б р░╕р░ор░╛р░Ър░╛р░░р░╛р░ир░┐р░Хр░┐ р░ир▒Зр░ир▒Б р░ор▒Ар░Хр▒Б р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░Чр░▓р░ир▒Б. р░ир▒Зр░ир▒Б р░ор▒Ар░Хр▒Б р░Ор░▓р░╛ р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░Чр░▓р░ир▒Б?',
        'kn': 'р▓ир▓╛р▓ир│Б р▓Хр▓ир│Нр▓ир▓бр▓Хр│Нр▓Хр│Ж р▓мр▓жр▓▓р▓╛р▓пр▓┐р▓╕р▓┐р▓жр│Нр▓жр│Зр▓ир│Ж. р▓ир▓╡р▓╛р▓кр│Бр▓░р│Н р▓кр▓Вр▓Ър▓╛р▓пр▓др│Н р▓╕р▓ор▓┐р▓др▓┐р▓п р▓╕р│Зр▓╡р│Жр▓Чр▓│р│Б р▓ор▓др│Нр▓др│Б р▓ор▓╛р▓╣р▓┐р▓др▓┐р▓Чр▓╛р▓Чр▓┐ р▓ир▓╛р▓ир│Б р▓ир▓┐р▓ор▓Чр│Ж р▓╕р▓╣р▓╛р▓п р▓ор▓╛р▓бр▓мр▓╣р│Бр▓жр│Б. р▓ир▓╛р▓ир│Б р▓ир▓┐р▓ор▓Чр│Ж р▓╣р│Зр▓Чр│Ж р▓╕р▓╣р▓╛р▓п р▓ор▓╛р▓бр▓мр▓╣р│Бр▓жр│Б?',
        'ml': 'р┤Юр┤╛р╡╗ р┤ор┤▓р┤пр┤╛р┤│р┤др╡Нр┤др┤┐р┤▓р╡Зр┤Хр╡Нр┤Хр╡Н р┤ор┤╛р┤▒р┤┐р┤пр┤┐р┤░р┤┐р┤Хр╡Нр┤Хр╡Бр┤ир╡Нр┤ир╡Б. р┤ир┤╡р┤╛р┤кр╡Вр╡╝ р┤кр┤Юр╡Нр┤Ър┤╛р┤пр┤др╡Нр┤др╡Н р┤╕р┤ор┤┐р┤др┤┐ р┤╕р╡Зр┤╡р┤ир┤Щр╡Нр┤Щр╡╛р┤Хр╡Нр┤Хр╡Бр┤В р┤╡р┤┐р┤╡р┤░р┤Щр╡Нр┤Щр╡╛р┤Хр╡Нр┤Хр╡Бр┤ор┤╛р┤пр┤┐ р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Ж р┤╕р┤╣р┤╛р┤пр┤┐р┤Хр╡Нр┤Хр┤╛р┤В. р┤Юр┤╛р╡╗ р┤Ор┤Щр╡Нр┤Щр┤ир╡Ж р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Ж р┤╕р┤╣р┤╛р┤пр┤┐р┤Хр╡Нр┤Хр┤╛р┤В?'
    };
    return changeMessages[language] || changeMessages['en'];
}

// Maps language codes to full names
function getLanguageName(code) {
    const languages = {
        'en': 'English',
        'hi': 'Hindi (рд╣рд┐рдВрджреА)',
        'mr': 'Marathi (рдорд░рд╛рдареА)',
        'gu': 'Gujarati (ркЧрлБркЬрк░рк╛ркдрлА)',
        'ta': 'Tamil (родрооро┐ро┤рпН)',
        'te': 'Telugu (р░др▒Жр░▓р▒Бр░Чр▒Б)',
        'kn': 'Kannada (р▓Хр▓ир│Нр▓ир▓б)',
        'ml': 'Malayalam (р┤ор┤▓р┤пр┤╛р┤│р┤В)'
    };
    return languages[code] || 'English';
}

// Get language instruction for API
function getLanguageInstruction(language) {
    const instructions = {
        'en': 'Please respond only in English.',
        'hi': 'рдХреГрдкрдпрд╛ рдХреЗрд╡рд▓ рд╣рд┐рдВрджреА рдореЗрдВ рдЙрддреНрддрд░ рджреЗрдВред Please respond only in Hindi language.',
        'mr': 'рдХреГрдкрдпрд╛ рдлрдХреНрдд рдорд░рд╛рдареА рднрд╛рд╖реЗрдд рдЙрддреНрддрд░ рджреНрдпрд╛ред Please respond only in Marathi language.',
        'gu': 'ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклркХрлНркд ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ркорк╛ркВ ркЬрк╡рк╛ркм ркЖрккрлЛред Please respond only in Gujarati language.',
        'ta': 'родропро╡рпБроЪрпЖропрпНродрпБ родрооро┐ро┤ро┐ро▓рпН роороЯрпНроЯрпБроорпЗ рокродро┐ро▓ро│ро┐роХрпНроХро╡рпБроорпН. Please respond only in Tamil language.',
        'te': 'р░жр░пр░Ър▒Зр░╕р░┐ р░др▒Жр░▓р▒Бр░Чр▒Бр░▓р▒Л р░ор░╛р░др▒Нр░░р░ор▒З р░╕р░ор░╛р░зр░╛р░ир░В р░Зр░╡р▒Нр░╡р░Вр░бр░┐ред Please respond only in Telugu language.',
        'kn': 'р▓жр▓пр▓╡р▓┐р▓Яр│Нр▓Яр│Б р▓Хр▓ир│Нр▓ир▓бр▓жр▓▓р│Нр▓▓р▓┐ р▓ор▓╛р▓др│Нр▓░ р▓Йр▓др│Нр▓др▓░р▓┐р▓╕р▓┐ред Please respond only in Kannada language.',
        'ml': 'р┤жр┤пр┤╡р┤╛р┤пр┤┐ р┤ор┤▓р┤пр┤╛р┤│р┤др╡Нр┤др┤┐р╡╜ р┤ор┤╛р┤др╡Нр┤░р┤В р┤Йр┤др╡Нр┤др┤░р┤В р┤ир╡╜р┤Хр╡Бр┤Хред Please respond only in Malayalam language.'
    };
    return instructions[language] || instructions['en'];
}

// Rate limiting helper functions
function isRateLimited() {
    const now = Date.now();
    
    // Remove requests older than 1 minute
    requestTimes = requestTimes.filter(time => now - time < RATE_LIMIT_WINDOW);
    
    // Check if we've exceeded the request limit
    if (requestTimes.length >= MAX_REQUESTS_PER_MINUTE) {
        console.warn('Rate limit reached: too many requests in the last minute');
        return true;
    }
    
    // Check minimum interval between requests
    if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
        console.warn('Rate limit: requests too frequent');
        return true;
    }
    
    return false;
}

function recordRequest() {
    const now = Date.now();
    lastRequestTime = now;
    requestTimes.push(now);
}

function getRateLimitMessage(language) {
    const rateLimitMessages = {
        'en': 'Please wait a moment before sending another message. The API has rate limits to ensure fair usage.',
        'hi': 'рдХреГрдкрдпрд╛ рджреВрд╕рд░рд╛ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдереЛрдбрд╝рд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рдХрд░реЗрдВред API рдореЗрдВ рдЙрдЪрд┐рдд рдЙрдкрдпреЛрдЧ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджрд░ рд╕реАрдорд╛рдПрдВ рд╣реИрдВред',
        'mr': 'рдХреГрдкрдпрд╛ рджреБрд╕рд░рд╛ рд╕рдВрджреЗрд╢ рдкрд╛рдард╡рдгреНрдпрд╛рдкреВрд░реНрд╡реА рдереЛрдбрд╛ рд╡реЗрд│ рдерд╛рдВрдмрд╛. рдиреНрдпрд╛рдпреНрдп рд╡рд╛рдкрд░рд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА API рдордзреНрдпреЗ рджрд░ рдорд░реНрдпрд╛рджрд╛ рдЖрд╣реЗрдд.',
        'gu': 'ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркмрлАркЬрлЛ рк╕ркВркжрлЗрк╢ ркорлЛркХрк▓ркдрк╛ рккрк╣рлЗрк▓рк╛ ркерлЛркбрлА рк░рк╛рк╣ ркЬрлБркУ. ркирлНркпрк╛ркпрк╕ркВркЧркд ркЙрккркпрлЛркЧ рк╕рлБркирк┐рк╢рлНркЪрк┐ркд ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ API ркорк╛ркВ ркжрк░ ркорк░рлНркпрк╛ркжрк╛ркУ ркЫрлЗ.',
        'ta': 'рооро▒рпНро▒рпКро░рпБ роЪрпЖропрпНродро┐ропрпИ роЕройрпБрокрпНрокрпБро╡родро▒рпНроХрпБ роорпБройрпН роЪро┐ро▒ро┐родрпБ роХро╛родрпНродро┐ро░рпБроХрпНроХро╡рпБроорпН. роиро┐ропро╛ропрооро╛рой рокропройрпНрокро╛роЯрпНроЯрпИ роЙро▒рпБродро┐роЪрпЖропрпНроп API роЗро▓рпН ро╡рпАрод ро╡ро░роорпНрокрпБроХро│рпН роЙро│рпНро│рой.',
        'te': 'р░ор░░р▒Кр░Х р░╕р░Вр░жр▒Зр░╢р░╛р░ир▒Нр░ир░┐ р░кр░Вр░кр░бр░╛р░ир░┐р░Хр░┐ р░ор▒Бр░Вр░жр▒Б р░Хр▒Кр░Вр░Ър▒Жр░В р░╡р▒Зр░Ър░┐ р░Йр░Вр░бр░Вр░бр░┐. р░ир▒Нр░пр░╛р░пр░ор▒Ир░и р░╡р░┐р░ир░┐р░пр▒Лр░Чр░╛р░ир▒Нр░ир░┐ р░ир░┐р░░р▒Нр░зр░╛р░░р░┐р░Вр░Ър░бр░╛р░ир░┐р░Хр░┐ API р░▓р▒Л р░░р▒Зр░Яр▒Н р░кр░░р░┐р░ор░┐р░др▒Бр░▓р▒Б р░Йр░ир▒Нр░ир░╛р░пр░┐.',
        'kn': 'р▓Зр▓ир│Нр▓ир│Кр▓Вр▓жр│Б р▓╕р▓Вр▓жр│Зр▓╢р▓╡р▓ир│Нр▓ир│Б р▓Хр▓│р│Бр▓╣р▓┐р▓╕р│Бр▓╡ р▓ор│Кр▓жр▓▓р│Б р▓жр▓пр▓╡р▓┐р▓Яр│Нр▓Яр│Б р▓╕р│Нр▓╡р▓▓р│Нр▓к р▓Хр▓╛р▓пр▓┐р▓░р▓┐. р▓ир│Нр▓пр▓╛р▓пр▓пр│Бр▓д р▓мр▓│р▓Хр│Жр▓пр▓ир│Нр▓ир│Б р▓Цр▓╛р▓др│Нр▓░р▓┐р▓кр▓бр▓┐р▓╕р▓▓р│Б API р▓пр▓▓р│Нр▓▓р▓┐ р▓жр▓░ р▓ор▓┐р▓др▓┐р▓Чр▓│р▓┐р▓╡р│Ж.',
        'ml': 'р┤ор┤▒р╡Нр┤▒р╡Кр┤░р╡Б р┤╕р┤ир╡Нр┤жр╡Зр┤╢р┤В р┤Ер┤пр┤пр╡Нр┤Хр╡Нр┤Хр╡Бр┤ир╡Нр┤ир┤др┤┐р┤ир╡Н р┤ор╡Бр┤ор╡Нр┤кр╡Н р┤жр┤пр┤╡р┤╛р┤пр┤┐ р┤Ер╡╜р┤кр╡Нр┤кр┤ир╡Зр┤░р┤В р┤Хр┤╛р┤др╡Нр┤др┤┐р┤░р┤┐р┤Хр╡Нр┤Хр╡Бр┤Х. р┤ир╡Нр┤пр┤╛р┤пр┤ор┤╛р┤п р┤Йр┤кр┤пр╡Лр┤Чр┤В р┤Йр┤▒р┤кр╡Нр┤кр┤╛р┤Хр╡Нр┤Хр┤╛р╡╗ API-р┤пр┤┐р╡╜ р┤▒р╡Зр┤▒р╡Нр┤▒р╡Н р┤кр┤░р┤┐р┤зр┤┐р┤Хр┤│р╡Бр┤гр╡Нр┤Яр╡Н.'
    };
    return rateLimitMessages[language] || rateLimitMessages['en'];
}

function showQuotaInformation() {
    const quotaInfo = {
        'en': 'тД╣я╕П API Usage Info:\nтАв Model: Gemini 1.5 Flash (v1 API - New Project)\nтАв Daily Quota: 1,500 requests/day (Excellent!)\nтАв Rate Limit: 15 requests/minute (Standard)\nтАв Status: Fresh unrestricted API key from new project\nтАв Performance: Full Gemini AI capabilities restored\nтАв Reset: Quota resets at midnight Pacific Time',
        'hi': 'тД╣я╕П API рдЙрдкрдпреЛрдЧ рдЬрд╛рдирдХрд╛рд░реА:\nтАв рдореЙрдбрд▓: рдЬреЗрдорд┐рдиреА 1.5 рдлреНрд▓реИрд╢ (v1 API - рдирдпрд╛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ)\nтАв рджреИрдирд┐рдХ рдХреЛрдЯрд╛: 1,500 рдЕрдиреБрд░реЛрдз/рджрд┐рди (рдЙрддреНрдХреГрд╖реНрдЯ!)\nтАв рджрд░ рд╕реАрдорд╛: 15 рдЕрдиреБрд░реЛрдз/рдорд┐рдирдЯ (рдорд╛рдирдХ)\nтАв рд╕реНрдерд┐рддрд┐: рдирдП рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реЗ рддрд╛рдЬрд╝реА рдЕрдкреНрд░рддрд┐рдмрдВрдзрд┐рдд API рдХреБрдВрдЬреА\nтАв рдкреНрд░рджрд░реНрд╢рди: рдкреВрд░реНрдг рдЬреЗрдорд┐рдиреА AI рдХреНрд╖рдорддрд╛рдПрдВ рдмрд╣рд╛рд▓',
        'mr': 'тД╣я╕П API рд╡рд╛рдкрд░ рдорд╛рд╣рд┐рддреА:\nтАв рдореЙрдбреЗрд▓: рдЬреЗрдорд┐рдиреА 1.5 рдлреНрд▓реЕрд╢ (v1 API - рдирд╡реАрди рдкреНрд░рдХрд▓реНрдк)\nтАв рджреИрдирдВрджрд┐рди рдХреЛрдЯрд╛: 1,500 рд╡рд┐рдирдВрддреНрдпрд╛/рджрд┐рд╡рд╕ (рдЙрддреНрдХреГрд╖реНрдЯ!)\nтАв рджрд░ рдорд░реНрдпрд╛рджрд╛: 15 рд╡рд┐рдирдВрддреНрдпрд╛/рдорд┐рдирдЯ (рдорд╛рдирдХ)\nтАв рд╕реНрдерд┐рддреА: рдирд╡реАрди рдкреНрд░рдХрд▓реНрдкрд╛рддреВрди рддрд╛рдЬреА рдЕрдкреНрд░рддрд┐рдмрдВрдзрд┐рдд API рдХреА\nтАв рдХрд╛рдордЧрд┐рд░реА: рд╕рдВрдкреВрд░реНрдг рдЬреЗрдорд┐рдиреА AI рдХреНрд╖рдорддрд╛ рдкреБрдирд░реНрд╕рдВрдЪрдпрд┐рдд'
    };
    
    const message = quotaInfo[activeLanguage] || quotaInfo['en'];
    addSystemMessage(message);
}

function getRateLimitStatus() {
    const now = Date.now();
    const recentRequests = requestTimes.filter(time => now - time < RATE_LIMIT_WINDOW);
    const remainingRequests = Math.max(0, MAX_REQUESTS_PER_MINUTE - recentRequests.length);
    const nextAvailableIn = Math.max(0, MIN_REQUEST_INTERVAL - (now - lastRequestTime));
    
    return {
        requestsUsed: recentRequests.length,
        requestsRemaining: remainingRequests,
        nextAvailableInMs: nextAvailableIn,
        nextAvailableInSec: Math.ceil(nextAvailableIn / 1000)
    };
}

// Handle sending a message
// Handle sending a message
function handleSendMessage() {
    const message = chatInput.value.trim();
    if (message.length === 0) return;
    
    // Check rate limiting before sending
    if (isRateLimited()) {
        const rateLimitMsg = getRateLimitMessage(activeLanguage);
        addBotMessage(rateLimitMsg);
        return;
    }
    
    // Add user message to chat
    addUserMessage(message);
    
    // Add user message to conversation history
    conversationHistory.push({
        role: 'user',
        parts: [{ text: message }]
    });
    
    // Clear input field
    chatInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Add helpful message for first-time users about rate limits
    const lastRequest = localStorage.getItem('lastAPIRequest');
    const now = Date.now();
    if (!lastRequest || (now - parseInt(lastRequest)) > 300000) { // 5 minutes
        setTimeout(() => {
            if (document.querySelector('.typing-indicator')) {
                addSystemMessage('ЁЯТб Note: This API has strict rate limits. If rate limited, the system will auto-retry in 60 seconds.');
            }
        }, 2000);
    }
    
    // Record the request for rate limiting
    recordRequest();
    
    // Get response from AI
    getAIResponse(message);
}

// Add a user message to the chat
function addUserMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('navapur-message', 'navapur-user-message');
    messageElement.textContent = message;
    messagesContainer.appendChild(messageElement);
    scrollToBottom();
}

// Add a bot message to the chat
function addBotMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('navapur-message', 'navapur-bot-message');
    // Use marked to convert markdown to HTML
    messageElement.innerHTML = marked.parse(message);
    messagesContainer.appendChild(messageElement);
    scrollToBottom();
    
    // Determine if we should speak this response
    const voiceMode = localStorage.getItem('navapur-voice-mode') || 'auto';
    let shouldSpeak = false;
    
    console.log(`Voice mode: ${voiceMode}, Voice input used: ${voiceInputUsed}`);
    
    switch (voiceMode) {
        case 'always':
            shouldSpeak = true;
            console.log('Voice mode ALWAYS: will speak response');
            break;
        case 'auto':
            shouldSpeak = voiceInputUsed; // Only speak if voice input was used
            console.log(`Voice mode AUTO: will speak response = ${shouldSpeak}`);
            break;
        case 'never':
            shouldSpeak = false;
            console.log('Voice mode NEVER: will not speak response');
            break;
    }
    
    if (shouldSpeak && typeof speakText === 'function') {
        // Extract plain text from markdown
        const plainText = message.replace(/[#*_~`\[\]()]/g, '').replace(/\n/g, ' ').trim();
        console.log(`Speaking response in ${activeLanguage}: ${plainText.substring(0, 50)}...`);
        speakText(plainText);
    } else if (shouldSpeak) {
        console.warn('speakText function not available');
    }
    
    // Reset voice input flag after processing
    voiceInputUsed = false;
}

// Add a system message (for notifications)
function addSystemMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('navapur-message', 'navapur-system-message');
    messageElement.style.backgroundColor = '#fff3e0';
    messageElement.style.color = '#f57c00';
    messageElement.style.fontSize = '12px';
    messageElement.style.fontStyle = 'italic';
    messageElement.style.textAlign = 'center';
    messageElement.style.margin = '8px auto';
    messageElement.style.maxWidth = '90%';
    messageElement.style.padding = '8px 12px';
    messageElement.style.borderRadius = '12px';
    messageElement.style.border = '1px solid #ffcc02';
    messageElement.textContent = message;
    messagesContainer.appendChild(messageElement);
    scrollToBottom();
    
    // Remove system message after 5 seconds
    setTimeout(() => {
        if (messageElement.parentNode) {
            messageElement.remove();
        }
    }, 5000);
}

// Show typing indicator
function showTypingIndicator() {
    const typingElement = document.createElement('div');
    typingElement.classList.add('navapur-message', 'navapur-bot-message', 'navapur-typing-indicator');
    typingElement.innerHTML = '<span></span><span></span><span></span>';
    typingElement.id = 'navapur-typing-indicator';
    messagesContainer.appendChild(typingElement);
    scrollToBottom();
}

// Remove typing indicator
function removeTypingIndicator() {
    const typingElement = document.getElementById('navapur-typing-indicator');
    if (typingElement) {
        typingElement.remove();
    }
}

// Scroll chat to bottom
function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Get AI response from Gemini API
async function getAIResponse(userMessage) {
    try {
        // Check for development mode first
        if (window.DEVELOPMENT_MODE || DEVELOPMENT_MODE) {
            console.log('Chatbot: Running in development mode with mock responses');
            const mockResponse = await getMockResponse(userMessage);
            removeTypingIndicator();
            addBotMessage(mockResponse);
            
            // Handle voice for development mode
            const voiceMode = localStorage.getItem('navapur-voice-mode') || 'auto';
            let shouldSpeak = false;
            
            switch (voiceMode) {
                case 'always':
                    shouldSpeak = true;
                    break;
                case 'auto':
                    shouldSpeak = voiceInputUsed; // Only speak if voice input was used
                    break;
                case 'never':
                    shouldSpeak = false;
                    break;
            }
            
            if (shouldSpeak && typeof speakText === 'function') {
                speakText(mockResponse, activeLanguage);
            }
            return;
        }
        
        // Check if API key is available
        if (!GEMINI_API_KEY) {
            console.error('Chatbot: API key not available');
            const errorMsg = 'Configuration error: API key not found. Please check the environment configuration.';
            removeTypingIndicator();
            addBotMessage(errorMsg);
            return;
        }

        // Create the system message with context and language instruction
        const systemMessage = `${PANCHAYAT_CONTEXT}\n\n${getLanguageInstruction(activeLanguage)}\n\nIMPORTANT: 
        1. You must respond in ${getLanguageName(activeLanguage)} language consistently throughout this conversation. Do not switch languages.
        2. Always assume questions are about Navapur Panchayat Samiti unless explicitly mentioned otherwise.
        3. Remember and reference previous parts of the conversation when relevant.
        4. If users ask general questions without mentioning Navapur, interpret them in the context of Navapur Panchayat Samiti services.
        5. Maintain conversation memory and continuity throughout our chat session.`;
        
        // Prepare the conversation contents
        const contents = [
            {
                role: 'user',
                parts: [{ text: systemMessage }]
            },
            ...conversationHistory
        ];

        console.log('Chatbot: Making API request to:', GEMINI_API_URL);
        console.log('Chatbot: Request body prepared, conversation history length:', conversationHistory.length);
        console.log('Chatbot: Using API key ending with:', GEMINI_API_KEY.slice(-8));
    
    // Show success message for new API key
    if (GEMINI_API_KEY.endsWith('igso0')) {
        console.log('тЬЕ New unrestricted API key detected - should have full functionality');
    }

        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: contents,
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                },
                safetySettings: [
                    {
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    }
                ]
            })
        });

        console.log('Chatbot: API response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Chatbot: API response error:', response.status, errorText);
            
            // Add detailed error logging for new API key
            console.log('Chatbot: Full error details for new API key:', {
                status: response.status,
                errorText: errorText,
                timestamp: new Date().toISOString(),
                apiKey: GEMINI_API_KEY.slice(-8)
            });
            
            // Handle rate limiting (429) - Project-level restrictions detected
            if (response.status === 429) {
                removeTypingIndicator();
                
                // Check for project-level restrictions
                if (errorText.includes('project_number:638291929677')) {
                    const restrictionMessage = `ЁЯЪи Project-level API restriction detected. This Google Cloud project (${errorText.match(/project_number:(\d+)/)?.[1]}) has quota limits of 0 requests/minute. You need to create a completely NEW Google Cloud project with a different project ID.`;
                    addBotMessage(restrictionMessage);
                    
                    setTimeout(() => {
                        addSystemMessage(`тЭМ Current API keys from this project won't work. Create new project at: https://console.cloud.google.com/`);
                    }, 3000);
                    
                } else if (errorText.includes('quota_limit_value": "0"') || errorText.includes('requests per minute')) {
                    const rateMessage = `тЪая╕П API rate limit (0 requests/minute). Auto-retrying in 30 seconds...`;
                    addBotMessage(rateMessage);
                    
                    setTimeout(async () => {
                        addSystemMessage(`ЁЯФД Retrying request...`);
                        const lastUserMessage = conversationHistory[conversationHistory.length - 1]?.parts[0]?.text;
                        if (lastUserMessage) {
                            await getAIResponse(lastUserMessage);
                        }
                    }, 30000);
                    
                } else if (errorText.includes('Quota exceeded') || errorText.includes('daily')) {
                    const quotaMessage = `Daily API quota exceeded. You've used your daily requests. The quota resets at midnight Pacific Time.`;
                    addBotMessage(quotaMessage);
                } else {
                    const rateMessage = `Rate limit exceeded. Please wait a moment before sending another message.`;
                    addBotMessage(rateMessage);
                }
                return;
            }
            
            // Handle API key/permission issues
            if (response.status === 403 || response.status === 401) {
                removeTypingIndicator();
                const authMessage = `API authentication issue. Your API key may not have access to the v1beta API or Gemini 2.0 Flash model. You may need to create a new API key with v1beta access.`;
                addBotMessage(authMessage);
                
                setTimeout(() => {
                    addSystemMessage(`Try: 1) Create new API key in Google AI Studio, 2) Or switch to other v1beta models like gemini-pro`);
                }, 2000);
                return;
            }
            
            // Handle model not found (wrong API version)
            if (response.status === 404 && errorText.includes('not found')) {
                removeTypingIndicator();
                const modelMessage = `Model not found with current API key. Your key may only have v1beta access. Switching to compatible model...`;
                addBotMessage(modelMessage);
                
                setTimeout(() => {
                    addSystemMessage(`Switching back to Gemini Pro (v1beta) for compatibility. You can create a new API key for v1 access.`);
                    // Auto-switch back to working model
                    window.location.reload();
                }, 3000);
                return;
            }
            
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const data = await response.json();
        console.log('Chatbot: API response received:', data);
        
        // Remove typing indicator
        removeTypingIndicator();
        
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
            const aiResponse = data.candidates[0].content.parts[0].text;
            addBotMessage(aiResponse);
            
            // Add AI response to conversation history
            conversationHistory.push({
                role: 'model',
                parts: [{ text: aiResponse }]
            });
            
            // Limit conversation history to prevent token overflow (keep last 10 exchanges)
            if (conversationHistory.length > 20) {
                conversationHistory = conversationHistory.slice(-20);
            }
        } else {
            // Handle API error
            console.error("Chatbot: Invalid API response structure:", data);
            const errorMsg = getErrorMessage(activeLanguage);
            addBotMessage(errorMsg);
        }
    } catch (error) {
        // Remove typing indicator
        removeTypingIndicator();
        
        // Handle error
        console.error("Chatbot: API Error details:", error);
        
        let errorMessage;
        if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Network connection error. Please check your internet connection and try again.';
        } else if (error.message.includes('403')) {
            errorMessage = 'API access forbidden. Please check the API key configuration.';
        } else if (error.message.includes('429')) {
            // Check if it's a daily quota issue or per-minute rate limit
            if (error.message.includes('quota') || error.message.includes('QUOTA_EXCEEDED') || 
                error.message.includes('daily') || error.message.includes('RPD')) {
                errorMessage = `Daily API quota exceeded (1,500 requests/day for free tier). The quota resets at midnight Pacific Time. You can upgrade to a paid plan for higher limits, or try again tomorrow.`;
                
                // Show quota information
                setTimeout(() => {
                    addSystemMessage(`Current limits: 1,500 requests/day (Free) vs Much Higher (Paid). Visit Google AI Studio to upgrade your plan.`);
                }, 2000);
            } else {
                // Regular per-minute rate limiting
                const retryAfter = Math.ceil((requestTimes.length > 0 ? 
                    Math.max(0, RATE_LIMIT_WINDOW - (Date.now() - requestTimes[0])) / 1000 : 30));
                errorMessage = `Too many requests per minute. Please wait ${retryAfter} seconds before trying again.`;
                
                // Show additional tips for rate limiting
                setTimeout(() => {
                    addSystemMessage(`Tip: Wait between messages to avoid rate limits. Current limit: ${MAX_REQUESTS_PER_MINUTE} requests per minute.`);
                }, 2000);
            }
        } else {
            errorMessage = getErrorMessage(activeLanguage);
        }
        
        addBotMessage(errorMessage);
    }
}

// Get error message in selected language
function getErrorMessage(language) {
    const errorMessages = {
        'en': "I'm having trouble connecting right now. Please try again later.",
        'hi': 'рдореБрдЭреЗ рдЕрднреА рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рд╣реЛ рд░рд╣реА рд╣реИред рдХреГрдкрдпрд╛ рдмрд╛рдж рдореЗрдВ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред',
        'mr': 'рдорд▓рд╛ рдЖрддреНрддрд╛ рдХрдиреЗрдХреНрдЯ рд╣реЛрдгреНрдпрд╛рдд рд╕рдорд╕реНрдпрд╛ рдпреЗрдд рдЖрд╣реЗ. рдХреГрдкрдпрд╛ рдирдВрддрд░ рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.',
        'gu': 'ркоркирлЗ ркЕркдрлНркпрк╛рк░рлЗ ркХркирлЗркХрлНркЯ ркХрк░рк╡рк╛ркорк╛ркВ рк╕ркорк╕рлНркпрк╛ ркЖрк╡рлА рк░рк╣рлА ркЫрлЗ. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккркЫрлАркерлА рклрк░рлАркерлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.',
        'ta': 'роОройроХрпНроХрпБ роЗрокрпНрокрпЛродрпБ роЗрогрпИрокрпНрокродро┐ро▓рпН роЪро┐роХрпНроХро▓рпН роЙро│рпНро│родрпБ. родропро╡рпБроЪрпЖропрпНродрпБ рокро┐ройрпНройро░рпН роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.',
        'te': 'р░ир░╛р░Хр▒Б р░Зр░кр▒Нр░кр▒Бр░бр▒Б р░Хр░ир▒Жр░Хр▒Нр░Яр▒Н р░Ър▒Зр░пр░бр░Вр░▓р▒Л р░╕р░ор░╕р▒Нр░п р░Йр░Вр░жр░┐. р░жр░пр░Ър▒Зр░╕р░┐ р░др░░р▒Нр░╡р░╛р░д р░ор░│р▒Нр░▓р▒А р░кр▒Нр░░р░пр░др▒Нр░ир░┐р░Вр░Ър░Вр░бр░┐.',
        'kn': 'р▓ир▓ир▓Чр│Ж р▓Ир▓Ч р▓╕р▓Вр▓кр▓░р│Нр▓Хр▓┐р▓╕р│Бр▓╡р▓▓р│Нр▓▓р▓┐ р▓др│Кр▓Вр▓жр▓░р│Ж р▓Зр▓жр│Ж. р▓жр▓пр▓╡р▓┐р▓Яр│Нр▓Яр│Б р▓ир▓Вр▓др▓░ р▓ор▓др│Нр▓др│Ж р▓кр│Нр▓░р▓пр▓др│Нр▓ир▓┐р▓╕р▓┐.',
        'ml': 'р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤Зр┤кр╡Нр┤кр╡Лр╡╛ р┤Хр┤гр┤Хр╡Нр┤▒р╡Нр┤▒р╡Н р┤Ър╡Жр┤пр╡Нр┤пр╡Бр┤ир╡Нр┤ир┤др┤┐р╡╜ р┤кр╡Нр┤░р┤╢р╡Нр┤ир┤ор╡Бр┤гр╡Нр┤Яр╡Н. р┤жр┤пр┤╡р┤╛р┤пр┤┐ р┤кр┤┐р┤ир╡Нр┤ир╡Ар┤Яр╡Н р┤╡р╡Ар┤гр╡Нр┤Яр╡Бр┤В р┤╢р╡Нр┤░р┤ор┤┐р┤Хр╡Нр┤Хр╡Бр┤Х.'
    };
    return errorMessages[language] || errorMessages['en'];
}

// ==================== VOICE ASSISTANT FUNCTIONS ====================

// Initialize Speech Recognition
function initVoiceAssistant() {
    // Check browser support
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        // Configure recognition
        recognition.continuous = false;
        recognition.interimResults = false;
        
        // Set language based on active language
        updateRecognitionLanguage();
        
        // Recognition event handlers
        recognition.onstart = handleRecognitionStart;
        recognition.onresult = handleRecognitionResult;
        recognition.onerror = handleRecognitionError;
        recognition.onend = handleRecognitionEnd;
    } else {
        console.warn('Speech recognition not supported in this browser');
    }
}

// Update recognition language based on selected language
function updateRecognitionLanguage() {
    if (!recognition) return;
    
    const languageMap = {
        'en': 'en-US',
        'hi': 'hi-IN',
        'mr': 'mr-IN',
        'gu': 'gu-IN',
        'ta': 'ta-IN',
        'te': 'te-IN',
        'kn': 'kn-IN',
        'ml': 'ml-IN'
    };
    
    recognition.lang = languageMap[activeLanguage] || 'en-US';
}

// Handle recognition start
function handleRecognitionStart() {
    isListening = true;
    updateMicrophoneButton(true);
    
    // Stop any ongoing speech synthesis
    if (synthesis.speaking) {
        synthesis.cancel();
    }
}

// Handle recognition result
function handleRecognitionResult(event) {
    const transcript = event.results[0][0].transcript;
    
    // Set the transcript as input value
    chatInput.value = transcript;
    
    // Mark that voice input was used
    voiceInputUsed = true;
    
    // Auto-send the message
    handleSendMessage();
}

// Handle recognition error
function handleRecognitionError(event) {
    console.error('Speech recognition error:', event.error);
    
    const errorMessages = {
        'en': 'Voice recognition error. Please try again.',
        'hi': 'рд╡реЙрдЗрд╕ рдкрд╣рдЪрд╛рди рддреНрд░реБрдЯрд┐ред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред',
        'mr': 'рд╡реНрд╣реЙрдЗрд╕ рдУрд│рдЦ рддреНрд░реБрдЯреА. рдХреГрдкрдпрд╛ рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.',
        'gu': 'рк╡рлЙркЗрк╕ ркУрк│ркЦ ркнрлВрк▓. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлАркерлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.',
        'ta': 'роХрпБро░ро▓рпН роЕроЯрпИропро╛ро│ рокро┐ро┤рпИ. роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.',
        'te': 'р░╡р░╛р░пр░┐р░╕р▒Н р░Чр▒Бр░░р▒Нр░др░┐р░Вр░кр▒Б р░▓р▒Лр░кр░В. р░жр░пр░Ър▒Зр░╕р░┐ р░ор░│р▒Нр░▓р▒А р░кр▒Нр░░р░пр░др▒Нр░ир░┐р░Вр░Ър░Вр░бр░┐.',
        'kn': 'р▓зр│Нр▓╡р▓ир▓┐ р▓Чр│Бр▓░р│Бр▓др▓┐р▓╕р│Бр▓╡р▓┐р▓Хр│Ж р▓жр│Лр▓╖. р▓жр▓пр▓╡р▓┐р▓Яр│Нр▓Яр│Б р▓ор▓др│Нр▓др│Ж р▓кр│Нр▓░р▓пр▓др│Нр▓ир▓┐р▓╕р▓┐.',
        'ml': 'р┤╡р╡Лр┤пр╡Нр┤╕р╡Н р┤др┤┐р┤░р┤┐р┤Ър╡Нр┤Ър┤▒р┤┐р┤пр╡╜ р┤кр┤┐р┤╢р┤Хр╡Н. р┤жр┤пр┤╡р┤╛р┤пр┤┐ р┤╡р╡Ар┤гр╡Нр┤Яр╡Бр┤В р┤╢р╡Нр┤░р┤ор┤┐р┤Хр╡Нр┤Хр╡Бр┤Х.'
    };
    
    if (event.error !== 'aborted') {
        addBotMessage(errorMessages[activeLanguage] || errorMessages['en']);
    }
}

// Handle recognition end
function handleRecognitionEnd() {
    isListening = false;
    updateMicrophoneButton(false);
}

// Toggle voice recognition
function toggleVoiceRecognition() {
    if (!recognition) {
        alert('Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
        return;
    }
    
    if (isListening) {
        recognition.stop();
    } else {
        // Update language before starting
        updateRecognitionLanguage();
        recognition.start();
    }
}

// Speak text using Text-to-Speech with better Indian voice support
function speakText(text) {
    // Cancel any ongoing speech
    if (synthesis.speaking) {
        synthesis.cancel();
    }
    
    // Wait a bit for voices to be available if they're not loaded yet
    const voices = synthesis.getVoices();
    if (voices.length === 0) {
        console.log('Voices not loaded yet, waiting...');
        setTimeout(() => speakText(text), 100);
        return;
    }
    
    // Create utterance
    currentUtterance = new SpeechSynthesisUtterance(text);
    
    // Set language with better Indian voice support
    const languageMap = {
        'en': 'en-IN', // Use Indian English instead of US English
        'hi': 'hi-IN',
        'mr': 'mr-IN',
        'gu': 'gu-IN',
        'ta': 'ta-IN',
        'te': 'te-IN',
        'kn': 'kn-IN',
        'ml': 'ml-IN'
    };
    
    const targetLang = languageMap[activeLanguage] || 'en-IN';
    currentUtterance.lang = targetLang;
    currentUtterance.rate = 0.85; // Slightly slower for better comprehension
    currentUtterance.pitch = 1;
    currentUtterance.volume = 0.9;
    
    console.log(`Trying to speak in ${activeLanguage} (${targetLang}):`, text.substring(0, 50) + '...');
    console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
    
    // Enhanced voice selection logic
    let selectedVoice = findBestVoice(voices, targetLang, activeLanguage);
    
    if (selectedVoice) {
        currentUtterance.voice = selectedVoice;
        console.log(`Selected voice: ${selectedVoice.name} (${selectedVoice.lang})`);
    } else {
        console.log('No suitable voice found, using system default');
        // Even if no specific voice is found, the utterance will still work with the lang setting
    }
    
    // Event handlers
    currentUtterance.onstart = () => {
        updateSpeakerButton(true);
        console.log('Speech started successfully');
    };
    
    currentUtterance.onend = () => {
        updateSpeakerButton(false);
        console.log('Speech ended successfully');
    };
    
    currentUtterance.onerror = (error) => {
        updateSpeakerButton(false);
        console.error('Speech error:', error);
        
        // Fallback: try with English if the current language fails
        if (activeLanguage !== 'en') {
            console.log('Retrying with English...');
            const englishUtterance = new SpeechSynthesisUtterance(text);
            englishUtterance.lang = 'en-IN';
            
            // Find English voice
            const englishVoice = voices.find(voice => 
                voice.lang === 'en-IN' || voice.lang === 'en-US' || voice.lang.startsWith('en')
            );
            if (englishVoice) {
                englishUtterance.voice = englishVoice;
            }
            
            synthesis.speak(englishUtterance);
        }
    };
    
    // Speak
    try {
        synthesis.speak(currentUtterance);
        console.log('Speech synthesis initiated');
    } catch (error) {
        console.error('Failed to initiate speech synthesis:', error);
    }
}

// Test voice in current language (for debugging)
function testVoiceInCurrentLanguage() {
    const testMessages = {
        'en': 'This is a test of voice synthesis in English.',
        'hi': 'рдпрд╣ рд╣рд┐рдВрджреА рдореЗрдВ рдЖрд╡рд╛рдЬ рд╕рдВрд╢реНрд▓реЗрд╖рдг рдХрд╛ рдкрд░реАрдХреНрд╖рдг рд╣реИред',
        'mr': 'рд╣реЗ рдорд░рд╛рдареА рднрд╛рд╖реЗрддреАрд▓ рдЖрд╡рд╛рдЬ рд╕рдВрд╢реНрд▓реЗрд╖рдгрд╛рдЪреА рдЪрд╛рдЪрдгреА рдЖрд╣реЗ.',
        'gu': 'ркЖ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рк╡рлЙркЗрк╕ рк╕рк┐ркирлНркерлЗрк╕рк┐рк╕ркирлА рккрк░рлАркХрлНрк╖рк╛ ркЫрлЗ.',
        'ta': 'роЗродрпБ родрооро┐ро┤ро┐ро▓рпН роХрпБро░ро▓рпН родрпКроХрпБрокрпНрокро┐ройрпН роЪрпЛродройрпИ.',
        'te': 'р░Зр░жр░┐ р░др▒Жр░▓р▒Бр░Чр▒Бр░▓р▒Л р░╡р░╛р░пр░┐р░╕р▒Н р░╕р░┐р░Вр░ер░╕р░┐р░╕р▒Н р░пр▒Кр░Хр▒Нр░Х р░кр░░р▒Ар░Хр▒Нр░╖.',
        'kn': 'р▓Зр▓жр│Б р▓Хр▓ир│Нр▓ир▓бр▓жр▓▓р│Нр▓▓р▓┐ р▓╡р▓╛р▓пр│Нр▓╕р│Н р▓╕р▓┐р▓Вр▓ер│Жр▓╕р▓┐р▓╕р│Н р▓кр▓░р│Ар▓Хр│Нр▓╖р│Ж.',
        'ml': 'р┤Зр┤др╡Н р┤ор┤▓р┤пр┤╛р┤│р┤др╡Нр┤др┤┐р┤▓р╡Ж р┤╡р╡Лр┤пр╡Нр┤╕р╡Н р┤╕р┤┐р┤ир╡Нр┤др┤╕р┤┐р┤╕р┤┐р┤ир╡Нр┤▒р╡Ж р┤кр┤░р╡Ар┤Хр╡Нр┤╖р┤гр┤ор┤╛р┤гр╡Н.'
    };
    
    const testMsg = testMessages[activeLanguage] || testMessages['en'];
    console.log('Testing voice with message:', testMsg);
    speakText(testMsg);
}

// Helper function to find the best voice for a language
function findBestVoice(voices, targetLang, activeLanguage) {
    console.log(`Finding voice for ${targetLang} (active language: ${activeLanguage})`);
    
    // Priority 1: Exact language match with quality indicators
    let voice = voices.find(v => 
        v.lang === targetLang && 
        (v.name.toLowerCase().includes('female') || 
         v.name.toLowerCase().includes('google') ||
         v.name.toLowerCase().includes('enhanced'))
    );
    if (voice) {
        console.log('Found exact match with quality indicator:', voice.name);
        return voice;
    }
    
    // Priority 2: Exact language match
    voice = voices.find(v => v.lang === targetLang);
    if (voice) {
        console.log('Found exact language match:', voice.name);
        return voice;
    }
    
    // Priority 3: Language prefix match (e.g., 'hi' matches 'hi-IN')
    const langPrefix = targetLang.split('-')[0];
    voice = voices.find(v => v.lang.startsWith(langPrefix));
    if (voice) {
        console.log('Found language prefix match:', voice.name);
        return voice;
    }
    
    // Priority 4: Special handling for Indian languages - use English Indian voice
    if (['hi', 'mr', 'gu', 'ta', 'te', 'kn', 'ml'].includes(activeLanguage)) {
        voice = voices.find(v => v.lang === 'en-IN');
        if (voice) {
            console.log('Using English Indian voice for Indian language:', voice.name);
            return voice;
        }
    }
    
    // Priority 5: Any English voice as fallback
    voice = voices.find(v => v.lang.startsWith('en'));
    if (voice) {
        console.log('Using English fallback voice:', voice.name);
        return voice;
    }
    
    // Priority 6: Default system voice
    console.log('No suitable voice found, will use system default');
    return null;
}

// Toggle speech synthesis with improved logic
function toggleSpeech() {
    if (synthesis.speaking) {
        // If currently speaking, stop it
        synthesis.cancel();
        updateSpeakerButton(false);
        return;
    }
    
    // Get current voice response mode
    const currentMode = localStorage.getItem('navapur-voice-mode') || 'auto';
    
    // Cycle through modes: auto -> always -> never -> auto
    let newMode;
    switch (currentMode) {
        case 'auto':
            newMode = 'always';
            break;
        case 'always':
            newMode = 'never';
            break;
        case 'never':
            newMode = 'auto';
            break;
        default:
            newMode = 'auto';
    }
    
    // Save the new mode
    localStorage.setItem('navapur-voice-mode', newMode);
    
    // Update button appearance
    updateSpeakerButtonStatus();
    
    // Show feedback message
    const feedbackMessages = {
        'auto': 'Voice Mode: AUTO - Responses will be spoken only when you use voice input',
        'always': 'Voice Mode: ALWAYS ON - All responses will be spoken',
        'never': 'Voice Mode: OFF - No voice responses'
    };
    
    // Add a temporary notification
    addSystemMessage(feedbackMessages[newMode]);
    
    console.log('Chatbot: Voice mode changed to:', newMode);
}

// Update microphone button appearance
function updateMicrophoneButton(active) {
    const micButton = document.getElementById('navapur-mic-button');
    if (micButton) {
        if (active) {
            micButton.classList.add('active');
            micButton.style.backgroundColor = '#ff5252';
        } else {
            micButton.classList.remove('active');
            micButton.style.backgroundColor = '';
        }
    }
}

// Update speaker button appearance
function updateSpeakerButton(speaking) {
    const speakerButton = document.getElementById('navapur-speaker-button');
    if (speakerButton) {
        if (speaking) {
            speakerButton.classList.add('active');
            speakerButton.style.backgroundColor = '#2196F3';
            speakerButton.style.color = 'white';
        } else {
            speakerButton.classList.remove('active');
            speakerButton.style.backgroundColor = '';
            speakerButton.style.color = '';
        }
    }
}

// Update speaker button to show voice mode status
function updateSpeakerButtonStatus() {
    const speakerButton = document.getElementById('navapur-speaker-button');
    const voiceMode = localStorage.getItem('navapur-voice-mode') || 'auto';
    
    if (speakerButton) {
        switch (voiceMode) {
            case 'auto':
                speakerButton.style.backgroundColor = '#ff9800'; // Orange for auto
                speakerButton.style.color = 'white';
                speakerButton.title = 'Voice Mode: AUTO - Click to change to ALWAYS ON';
                break;
            case 'always':
                speakerButton.style.backgroundColor = '#4caf50'; // Green for always on
                speakerButton.style.color = 'white';
                speakerButton.title = 'Voice Mode: ALWAYS ON - Click to turn OFF';
                break;
            case 'never':
                speakerButton.style.backgroundColor = '';
                speakerButton.style.color = '#666666';
                speakerButton.title = 'Voice Mode: OFF - Click to change to AUTO';
                break;
        }
    }
}

// Test API connection
async function testAPIConnection() {
    console.log('Chatbot: Testing API connection...');
    
    if (!GEMINI_API_KEY) {
        console.error('Chatbot: No API key available for testing');
        return false;
    }
    
    try {
        const testContents = [{
            role: 'user',
            parts: [{ text: 'Hello, this is a test message. Please respond with "API connection successful".' }]
        }];
        
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: testContents,
                generationConfig: {
                    temperature: 0.1,
                    maxOutputTokens: 50,
                }
            })
        });
        
        if (!response.ok) {
            console.error('Chatbot: API test failed with status:', response.status);
            return false;
        }
        
        const data = await response.json();
        console.log('Chatbot: API test successful:', data);
        return true;
    } catch (error) {
        console.error('Chatbot: API test error:', error);
        return false;
    }
}

// ==================== INITIALIZE ====================

// Initialize chat when DOM is loaded
document.addEventListener('DOMContentLoaded', async () => {
    console.log('Chatbot: DOM loaded, initializing...');
    
    initChat();
    initVoiceAssistant();
    
    // Test API connection with new unrestricted key
    console.log('Chatbot: Testing API connection with new key...');
    const apiWorking = await testAPIConnection();
    if (!apiWorking) {
        console.warn('Chatbot: API connection test failed. Users may experience issues.');
    } else {
        console.log('тЬЕ API connection successful with new key!');
    }
    
    // Load voices and wait for them to be available
    const loadVoices = () => {
        const voices = synthesis.getVoices();
        console.log(`Chatbot: ${voices.length} voices loaded`);
        
        // Log available Indian language voices for debugging
        const indianVoices = voices.filter(voice => 
            voice.lang.includes('IN') || 
            ['hi', 'mr', 'gu', 'ta', 'te', 'kn', 'ml'].some(lang => voice.lang.startsWith(lang))
        );
        console.log('Available Indian voices:', indianVoices.map(v => `${v.name} (${v.lang})`));
    };
    
    // Load voices (needed for some browsers)
    if (synthesis.onvoiceschanged !== undefined) {
        synthesis.onvoiceschanged = loadVoices;
    }
    
    // Initial voice load
    loadVoices();
    
    // Add event listeners for voice buttons
    const micButton = document.getElementById('navapur-mic-button');
    const speakerButton = document.getElementById('navapur-speaker-button');
    
    if (micButton) {
        micButton.addEventListener('click', toggleVoiceRecognition);
    }
    
    if (speakerButton) {
        speakerButton.addEventListener('click', toggleSpeech);
        // Set initial button status based on saved preference (default to 'auto')
        if (!localStorage.getItem('navapur-voice-mode')) {
            localStorage.setItem('navapur-voice-mode', 'auto');
        }
        updateSpeakerButtonStatus();
    }
    
    console.log('Chatbot: Initialization complete');
    
    // Show success message for new unrestricted API
    if (!DEVELOPMENT_MODE) {
        console.log('я┐╜ Real API Mode: ACTIVE - Using Gemini AI responses');
        setTimeout(() => {
            addSystemMessage('я┐╜ Gemini AI is now active with full functionality! Ask me anything about Navapur Panchayat Samiti.');
        }, 2000);
    }
    
    // Add global test functions for debugging
    window.testChatbotVoice = testVoiceInCurrentLanguage;
    window.getRateLimitStatus = getRateLimitStatus;
    window.showQuotaInfo = showQuotaInformation;
    
    // Add development mode toggle
    window.toggleDevelopmentMode = function() {
        window.DEVELOPMENT_MODE = !window.DEVELOPMENT_MODE;
        console.log('Development mode:', window.DEVELOPMENT_MODE ? 'ON (Mock responses)' : 'OFF (Real API)');
        addSystemMessage(`ЁЯФз Development mode ${window.DEVELOPMENT_MODE ? 'enabled' : 'disabled'}. ${window.DEVELOPMENT_MODE ? 'Using mock responses.' : 'Using real API.'}`);
    };
    
    // Make development mode accessible globally
    window.DEVELOPMENT_MODE = DEVELOPMENT_MODE;
    
    // Add function to test API with proper delay
    window.testAPIWithDelay = async function() {
        console.log('Testing API with 60 second delay...');
        addSystemMessage('тП│ Testing API connection with 60 second delay... Please wait.');
        
        // Wait 60 seconds
        await new Promise(resolve => setTimeout(resolve, 60000));
        
        console.log('Now attempting API call...');
        addSystemMessage('ЁЯФД 60 seconds passed, now testing API...');
        
        // Test with a simple message
        handleSendMessage('Hello, testing API connection');
    };
    
    console.log('Chatbot: Type testChatbotVoice() in console to test voice in current language');
    console.log('Chatbot: Type getRateLimitStatus() in console to check rate limit status');
    console.log('Chatbot: Type showQuotaInfo() in console to see API quota information');
    console.log('Chatbot: Type testAPIWithDelay() in console to test API with 60 second delay');
    console.log('Chatbot: Type toggleDevelopmentMode() to switch between mock and real API');
});